<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Robot</title>
  <link href="bootstrap.min.css" rel="stylesheet" />
  <script src="bootstrap.min.js"></script>
  <script src="highcharts.js"></script>
  <script src="highcharts-more.js"></script>
  <script src="exporting.js"></script>
  <script src="export-data.js"></script>
</head>

<body>
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol id="android2" viewBox="0 0 16 16">
      <path
        d="m10.213 1.471.691-1.26c.046-.083.03-.147-.048-.192-.085-.038-.15-.019-.195.058l-.7 1.27A4.832 4.832 0 0 0 8.005.941c-.688 0-1.34.135-1.956.404l-.7-1.27C5.303 0 5.239-.018 5.154.02c-.078.046-.094.11-.049.193l.691 1.259a4.25 4.25 0 0 0-1.673 1.476A3.697 3.697 0 0 0 3.5 5.02h9c0-.75-.208-1.44-.623-2.072a4.266 4.266 0 0 0-1.664-1.476ZM6.22 3.303a.367.367 0 0 1-.267.11.35.35 0 0 1-.263-.11.366.366 0 0 1-.107-.264.37.37 0 0 1 .107-.265.351.351 0 0 1 .263-.11c.103 0 .193.037.267.11a.36.36 0 0 1 .112.265.36.36 0 0 1-.112.264Zm4.101 0a.351.351 0 0 1-.262.11.366.366 0 0 1-.268-.11.358.358 0 0 1-.112-.264c0-.103.037-.191.112-.265a.367.367 0 0 1 .268-.11c.104 0 .19.037.262.11a.367.367 0 0 1 .107.265c0 .102-.035.19-.107.264ZM3.5 11.77c0 .294.104.544.311.75.208.204.46.307.76.307h.758l.01 2.182c0 .276.097.51.292.703a.961.961 0 0 0 .7.288.973.973 0 0 0 .71-.288.95.95 0 0 0 .292-.703v-2.182h1.343v2.182c0 .276.097.51.292.703a.972.972 0 0 0 .71.288.973.973 0 0 0 .71-.288.95.95 0 0 0 .292-.703v-2.182h.76c.291 0 .54-.103.749-.308.207-.205.311-.455.311-.75V5.365h-9v6.404Zm10.495-6.587a.983.983 0 0 0-.702.278.91.91 0 0 0-.293.685v4.063c0 .271.098.501.293.69a.97.97 0 0 0 .702.284c.28 0 .517-.095.712-.284a.924.924 0 0 0 .293-.69V6.146a.91.91 0 0 0-.293-.685.995.995 0 0 0-.712-.278Zm-12.702.283a.985.985 0 0 1 .712-.283c.273 0 .507.094.702.283a.913.913 0 0 1 .293.68v4.063a.932.932 0 0 1-.288.69.97.97 0 0 1-.707.284.986.986 0 0 1-.712-.284.924.924 0 0 1-.293-.69V6.146c0-.264.098-.491.293-.68Z" />
    </symbol>
    <symbol id="exclamation" viewBox="0 0 16 16">
      <path
        d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z">
      </path>
    </symbol>
  </svg>

  <div class="container">
    <!-- header -->
    <header class="d-flex flex-column flex-xl-row align-items-center py-3 mb-4 border-bottom">
      <div class="d-flex align-items-center mb-3 mb-xl-0 me-xl-auto">
        <div class="d-flex align-items-center my-2 my-lg-0 me-lg-auto link-body-emphasis text-decoration-none">
          <svg class="bi me-2" width="40" height="32" role="img" aria-label="Robot">
            <use xlink:href="#android2"></use>
          </svg>
          <span class="fs-4">Robot</span>
        </div>
      </div>
      <div class="d-flex align-items-center">
        <small class="text-center text-wrap">Цилиндрический робот с маятниковым управлением. Выпускная квалификационная
          работа магистра. Мочалова Анастасия, 3821М1ПМкн, ИТММ ННГУ.</small>
      </div>
    </header>

    <!-- connection alert -->
    <div class="alert alert-warning d-flex align-items-center" id="connection_alert" role="alert">
      <svg class="bi bi-exclamation-triangle-fill flex-shrink-0 me-2" width="24" height="24" fill="currentColor"
        role="img" aria-label="Warning:">
        <use xlink:href="#exclamation"></use>
      </svg>
      <div>Связь с роботом потеряна</div>
    </div>

    <!-- charts -->
    <div class="row mb-3">
      <div class="col-lg-8">
        <div class="row">
          <div class="col-md-6">
            <figure class="highcharts-figure">
              <div id="speed-chart" class="chart-container"></div>
            </figure>
          </div>
          <div class="col-md-6">
            <figure class="highcharts-figure">
              <div id="acceleration-chart" class="chart-container"></div>
            </figure>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <figure class="highcharts-figure">
          <div id="gyro-chart"></div>
        </figure>
      </div>
    </div>

    <!-- nav -->
    <div class="row mb-3">
      <div class="col">
        <ul class="nav nav-underline flex-nowrap mb-2 mb-md-0" id="tabs-nav" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="control-tab" data-bs-toggle="tab" data-bs-target="#control-tab-pane"
              type="button" role="tab" aria-controls="control-tab-pane" aria-selected="false">Ручное управление</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="program-tab" data-bs-toggle="tab" data-bs-target="#program-tab-pane"
              type="button" role="tab" aria-controls="program-tab-pane" aria-selected="true">
              Программа
              <span class="badge text-bg-warning " id="stop_bage">Stop</span>
              <span class="badge text-bg-success d-none" id="run_bage">Run</span>
            </button>
          </li>
        </ul>
      </div>
    </div>

    <!-- tabs -->
    <div class="tab-content mb-3" id="tabs-content">
      <!-- control tab -->
      <div class="tab-pane fade show active" id="control-tab-pane" role="tabpanel" aria-labelledby="control-tab"
        tabindex="0">
        <div class="row mb-3">
          <div class="col-sm-3">
            <label for="acceleration" class="form-label">Питание</label>
          </div>
          <div class="col-sm-8">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" role="switch" id="power" checked
                style="width: 3rem; height: 1.5rem;" oninput="power_value.innerHTML = this.checked ? 'Вкл' : 'Выкл'"
                onchange="this.checked ? powerOn() : powerOff()">
              <small id="power_value" class="form-text ms-3">Вкл</small>
            </div>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-sm-3">
            <label for="speed" class="form-label">Скорость вращения, шагов/с</label>
          </div>
          <div class="col-11 col-sm-8">
            <input type="range" class="form-range" min="-3000" max="3000" value="0" id="speed" list="speed-markers"
              oninput="speed_value.innerHTML = this.value" onchange="setSpeed(this.value)">
            <div class="row form-text">
              <span class="col text-start">Назад</span>
              <span class="col-1 text-center">0</span>
              <span class="col text-end">Вперед</span>
            </div>
            <datalist id="speed-markers">
              <option value="-3000"></option>
              <option value="-2048"></option>
              <option value="-1024"></option>
              <option value="-512"></option>
              <option value="0"></option>
              <option value="512"></option>
              <option value="1024"></option>
              <option value="2048"></option>
              <option value="3000"></option>
            </datalist>
          </div>
          <div class="col-1 d-flex justify-content-end">
            <small class="form-text m-0" id="speed_value">0</small>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-sm-3">
            <label for="acceleration" class="form-label">Ускорение, шагов/с<sup>2</sup></label>
          </div>
          <div class="col-11 col-sm-8">
            <input type="range" class="form-range" min="1" max="3000" value="512" id="acceleration"
              list="acceleration-markers" oninput="acceleration_value.innerHTML = this.value"
              onchange="setAcceleration(this.value)">
            <div class="d-flex form-text">
              <div class="col">Медленно</div>
              <div class="col text-end">Быстро</div>
            </div>
            <datalist id="acceleration-markers">
              <option value="0"></option>
              <option value="512"></option>
              <option value="1024"></option>
              <option value="2048"></option>
              <option value="3000"></option>
            </datalist>
          </div>
          <div class="col-1 d-flex justify-content-end">
            <small class="form-text m-0" id="acceleration_value">512</small>
          </div>
        </div>

        <div class="row mb-3 gy-2">
          <div class="col-sm-4">
            <button class="w-100 btn btn-primary" id="start_stepper" onclick="startStepper()">Старт</button>
          </div>
          <div class="col-sm-4">
            <button class="w-100 btn btn-secondary" id="stop_stepper" onclick="stopStepper()">Стоп</button>
          </div>
          <div class="col-sm-4">
            <button class="w-100 btn btn-outline-secondary" id="reset_stepper" onclick="resetStepper()">Сброс</button>
          </div>
        </div>
      </div>

      <!-- program tab -->
      <div class="tab-pane fade" id="program-tab-pane" role="tabpanel" aria-labelledby="program-tab" tabindex="0">
        <div class="row mb-3">
          <small class="col-md-5 order-md-last text-body-secondary">
            <h6 class="mb-3">Справка по программированию шагового двигателя</h6>
            <p>Один оборот двигателя - 2048 шагов.</p>
            <p>Команды управления:</p>
            <ul>
              <li><strong>speed n</strong> - Установить скорость вращения в n шагов/с.</li>
              <li><strong>acceleration n</strong> - Установить ускорение в n шагов/с<sup>2</sup>.</li>
              <li><strong>rotate n</strong> - Повернуться на n шагов вперед (n > 0) или назад (n < 0).</li>
              <li><strong>timer n</strong> - Запустить таймер команды rotate на n миллисекунд.</li>
              <li><strong>stop n</strong> - Остановить вращение плавно (n = 0) или резко (n = 1).</li>
              <li><strong>pause n</strong> - Сделать паузу в n миллисекунд.</li>
              <li><strong>repeat</strong> - Повторить программу с начала.</li>
            </ul>
          </small>

          <div class="col-md-7">
            <textarea class="form-control" id="program" rows="11">
acceleration 500
speed 1000
rotate 2048
pause 3000
speed 500
timer 250
rotate -100500000
stop 1
repeat</textarea>
          </div>
        </div>

        <div class="row mb-3 gy-2">
          <div class="col-sm-4">
            <button class="w-100 btn btn-primary" id="open_program"
              onclick="file.value=''; file.click()">Открыть...</button>
            <input class="d-none" type="file" id="file"
              onchange="readTextFile(this.files[0]).then((text) => (program.value = text)).catch((e) => console.error('Read file error.', e))">
          </div>
          <div class="col-sm-4">
            <button class="w-100 btn btn-primary" id="run_program"
              onclick="runProgram(program.value)">Выполнить</button>
          </div>
          <div class="col-sm-4">
            <button class="w-100 btn btn-secondary" id="stop_program" onclick="stopProgram()">Стоп</button>
          </div>
        </div>

      </div>
    </div>

    <footer class="d-flex flex-column flex-sm-row align-items-center py-3 my-4 border-top">
      <div class="d-flex me-sm-auto">
        <small>© 2023 Мочалова А.Р.</small>
      </div>
      <div>
        <a href="mailto: anastasia.mochalova@google.com"><small>anastasia.mochalova@google.com</small></a>
      </div>
    </footer>

    <div class="mb-4">
      <small class="text-secondary text-opacity-25" id="millis">Disconnected</small>
    </div>
  </div>

  <script src="robot-events.js"></script>
  <script src="robot-api.js"></script>
  <script src="robot-charts.js"></script>
</body>

</html>