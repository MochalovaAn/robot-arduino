# Робот

Прошивка Arduino для управления цилиндрическим роботом с маятниковым управлением.

Возможности:

- WiFi точка доступа `Robot`
- DNS сервер
- WEB сервер
- Captive Portal
- Управление и программирование с помощью HTTP запросов
- EventSource интерфейс параметров

# Сборка прошивки

Раздел в разработке...

# WiFi точка доступа

Название: `Robot`  
Пароль: `1234567890`

# Управление с помощью HTTP запросов

Для получения параметров, и управления шаговым двигателем и программирования робота используются HTTP запросы `GET` и `POST`.

## Шаговый двигатель

### Скорость вращения, шагов в секунду

Заданная скорость вращения. Допускается менять скорость вращения _на ходу_, прямо в процессе вращения.

```
POST /stepper/speed?v=123
GET /stepper/speed
```

### Ускорение, шагов в секунду за секунду

Двигатель физически не может резко увеличить/сбросить скорость вращения, поэтому ему приходится менять ее плавно. `Ускорение` определяет, как быстро двигатель наберет/сбросит заданную скорость вращения.

```
POST /stepper/acceleration?v=123
GET /stepper/acceleration
```

### Повернуться на указанное количество шагов/до указанной позиции

Положительное значение - по часовой стрелке, отрицательное - против часовой стрелки.

Двигатель начинает вращение сразу после получения команды. После поворота на указанное количество шагов двигатель останавливается. Начало вращения и остановка делаются плавно с заданным ускорением.

```
POST /stepper/move?relative=2048
POST /stepper/move?absolute=2048
```

### Остановить вращение (стоп)

Останавливает вращение. Если параметр `force` не задан, то останавливает плавно с заданным ускорением. Иначе останавливает резко. Заданные скорость и ускорение и после остановки не меняются.

```
POST /stepper/stop?force=1
```

### Сброс

Резко останавливает вращение. Сбрасывает `текущую позицию` (см. ниже) в указанную, заданные скорость и ускорение не меняются. Используется для установки текущей позиции двигателя как нулевой позиции.

```
POST /stepper/reset?position=0
```

### Текущая и конечная позиции

На валу двигателя имеется две виртуальные метки - `текущая позиция` и `конечная позиция`.

При включении питания двигателя обе метки равны 0. При подаче команды `повернуться` двигатель смещает `конечную` позицию относительно `текущей` на указанное число шагов и начинает вращение до тех пор, пока `текущая` позиция не достигнет `конечной`.

```
GET /stepper/current-position
GET /stepper/target-position
```

### Текущая скорость вращения

При подаче команды `повернуться` двигатель сначала плавно меняет `текущую скорость` от 0 до заданной, а затем продолжает вращаться с постоянной скоростью.

Если задано малое количество шагов для поворота или небольшое `ускорение`, то к моменту окончания вращения двигатель может не успеть набрать заданную скорость.

```
GET /stepper/current-speed
```

### Осталось шагов повернуться

Разница между `текущей позицией` и `конечной позицией`. Как только значение станет равным 0 двигатель остановится.

```
GET /stepper/distance-to-go
```

### Вращается ли двигатель

```
GET /stepper/is-running
```

### Количество шагов двигателя на один оборот

```
GET /stepper/steps-per-revolution
```

## Гироскоп

### Крен

Крылья влево/вправо, вокруг оси X.

```
GET /imu/roll
```

### Тангаж

Нос вверх/вниз, вокруг оси Y.

```
GET /imu/pitch
```

### Рыскание

Нос влево/вправо, вокруг оси Z.

```
GET /imu/yaw
```

### Температура

Температура датчика, градус C.

```
GET /imu/t
```

# EventSource интерфейс

`EventSource` интерфейс используется для получения серверных событий (server-sent events, SSE) об изменении параметров робота.

## URL событий

```
/events
```

## События робота

Раздел в разработке...

## Пример использования

```javascript
var source = new EventSource("/events");

source.addEventListener(
  "open",
  (event) => console.log("Robot Connected"),
  false
);

source.addEventListener(
  "error",
  (event) => {
    if (event.target.readyState != EventSource.OPEN) {
      console.log("Robot Disconnected");
    }
  },
  false
);

source.addEventListener(
  "test",
  (event) => console.log("Robot Yaw", event.data),
  false
);
```

## Программирование
